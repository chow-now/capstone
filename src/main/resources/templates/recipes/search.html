<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="partials/head :: head('Results')">
    <meta charset="UTF-8">
    <title>Results</title>
</head>
<body>

<form class="w-50 mx-auto" th:action="@{/search}" method="get">
    <input type="text" class="form-control" id="main_search" placeholder="Enter ingredients ex. tomato, lettuce, apple" name="term">
</form>



<!--    // Dump recipes here-->
<div class="recipes row">

</div>

// Modal to display recipe information - This can be changed later on





<th:block th:include="partials/scripts :: scripts"></th:block>

<script th:inline="javascript">

    // In the head
    let spoonApi = document.querySelector('meta.spoonApi').content;

    if (document.getElementById('main_search') == null) {
        console.log("yo, it's null");
    } else {
        //var term = $('input').val();
        //console.log(term); // Always return null
        var searchString;
        // console.log(searchString);
        var urlSearchString = window.location.href;
        var url = new URL(urlSearchString);
        var searchParam = url.searchParams.get("term");
        searchString = searchParam.replace(/,|,\s/g, ",+");
        console.log("url string" + searchString);

        // Search by ingredients
        $.ajax("https://api.spoonacular.com/recipes/findByIngredients?ingredients=" + searchParam + "&number=50&apiKey=" + spoonApi + "")
            .done(function(results) {
                console.log(results);

                let recipe = "";

                for (let i = 0; i < results.length; i++) {
                    //console.log(item.title)
                    recipe += '<h5>' + results[i].title + '</h5>';
                    recipe += '<img src="' + results[i].image + '"/>';
                    recipe += '<button class="btn btn-primary viewRecipe" id="' + results[i].id + '">' + " View " + '</button>'
                }
                $('.recipes').html(recipe);


                $('.viewRecipe').on('click', function () {
                    console.log(this.id + " button id");

                    $.ajax("https://api.spoonacular.com/recipes/" + this.id + "/information?includeNutrition=false&apiKey=" + spoonApi + "")
                        .done(function(results) {

                            // Recipe Information
                            let image = "";
                            let title = "";
                            let ingredients = "";
                            let instructions = "";
                            let category = "";
                            let source = "";

                            console.log(results.title);

                            image += '<img class="img-fluid" src="' + results.image + '" alt="" />';

                            title += results.title + " by " + '<a href="' + results.sourceUrl + '"</a>';

                            // Categories
                            if(results.cuisines.length == 0) {
                                category += '<li class="">' + 'Unknown category' + '</li>';
                            } else {
                                for (let i = 0; i < results.cuisines.length; i++) {
                                    category += '<li>' + results.cuisines[i] + '</li>'
                                }
                            }

                            // Ingredients List
                            if (results.extendedIngredients.length == 0) {
                                ingredients += 'No ingredients recorded'
                            } else {
                                for (let i = 0; i < results.extendedIngredients.length; i++) {
                                    ingredients += '<li>' + results.extendedIngredients[i].amount + " "
                                                          + results.extendedIngredients[i].unit + " "
                                                          + results.extendedIngredients[i].originalName + '</li>';
                                }
                            }

                            // Grab Instructions
                            instructions += '<p>' + results.instructions + '</p>'
                        })
                })
            })
        }


</script>
</body>
</html>