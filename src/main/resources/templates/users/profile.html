<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>User Profile</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">

<!--  CUSTOM PROFILE CSS -->
  <style>

    /*plus minus input buttons*/
    .qty .count {
      color: #000;
      /*display: inline-block;*/
      vertical-align: top;
      font-size: 20px;
      font-weight: 700;
      line-height: 30px;
      padding: 0 2px;
      min-width: 60px;
      text-align: center;
    }
    .qty .plus {
      cursor: pointer;
      /*display: inline-block;*/
      vertical-align: top;
      color: black;
      width: 30px;
      height: 30px;
      font: 30px/1 Arial,sans-serif;
      text-align: center;
      border-radius: 50%;
    }
    .qty .minus {
      cursor: pointer;
      /*display: inline-block;*/
      vertical-align: top;
      color: black;
      width: 30px;
      height: 30px;
      font: 30px/1 Arial,sans-serif;
      text-align: center;
      border-radius: 50%;
      background-clip: padding-box;
    }
    .minus:hover{
      background-color: white !important;
    }
    .plus:hover{
      background-color: white !important;
    }
    .count{
      border: 0;
      width: 5%;
    }
    .count::-webkit-outer-spin-button,
    .count::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .count:disabled{
      background-color:white;
    }

    /* table css */
    .hm-gradient {
      background-image: linear-gradient(to top, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%);
    }
    .darken-grey-text {
      color: #2E2E2E;
    }
    .input-group.md-form.form-sm.form-2 input {
      border: 1px solid #bdbdbd;
      border-top-left-radius: 0.25rem;
      border-bottom-left-radius: 0.25rem;
    }
    .input-group.md-form.form-sm.form-2 input.purple-border {
      border: 1px solid #9e9e9e;
    }
    .input-group.md-form.form-sm.form-2 input[type=text]:focus:not([readonly]).purple-border {
      border: 1px solid #ba68c8;
      box-shadow: none;
    }
    .form-2 .input-group-addon {
      border: 1px solid #ba68c8;
    }
    .danger-text {
      color: #ff3547;
    }
    .success-text {
      color: #00C851;
    }
    .table-bordered.red-border, .table-bordered.red-border th, .table-bordered.red-border td {
      border: 1px solid #ff3547!important;
    }
    .table.table-bordered th {
      text-align: center;
    }

    @media only screen and (max-width: 500px) {
      .fas{
        font-size: 1rem;
      }
    }
    @media only screen and (max-width: 700px) {
      .recipe-card{
        width: 100%!important;
      }
    }
  </style>
</head>
<body>
<!--<nav th:include="partials/navbar.html :: nav"></nav>-->


<main>
  <!--Main Container-->
    <!-- USER INFO -->
    <div class="container mt-4">
      <div class="row">
        <!-- IF CUSTOMER HAS PROFILE PICTURE -->
        <div class="col-4 col-sm-3 text-center px-lg-5 mb-4">
          <img width="100%" th:src="${user.avatar}" class="rounded-circle shadow-sm" style="border: 5px solid rgb(255, 255, 255);">
        </div>
        <div class="col-8 col-sm-9 mb-4">
          <div class="mb-2">
            <h2 class="mb-0" th:text="${user.firstName}"></h2>
          </div>
          <!-- IF CUSTOMER IS HAS ABOUT ME ELSE -->
          <p>
            <em>
              <small th:text="${user.getAboutMe()} ?: 'Introduce yourself to the community by writing a little about yourself.'"></small>
            </em>
          </p>
          <!-- EDIT PROFILE LINK -->
          <div>
              <!--Todo: ADD TH SECURITY TO CHECK IF LOGGEDIN USER IS PROFILE OWNER-->
<!--            <button sec:authorize="isAuthenticated()" th:if="${#authentication.principal.id == user.id}" type="button" class="el-button el-button&#45;&#45;default el-button&#45;&#45;small is-plain">-->
<!--              <a th:href="@{/users/{id}/edit(id=${user.id})}">Edit Profile</a>-->
<!--            </button>-->
            <!--Todo: ADD IF NOT LOGGEDIN USER IS PROFILE OWNER-->
            <button th:if="${isFollowing}" class="btn" disabled> Following </button>
            <button th:unless="${isFollowing}" id="addFriend" type="submit" class="btn"> Follow </button>
          </div>
        </div>
      </div>
      <!-- END USER INFO -->


<!--          LOGGED IN USERS TAB-->
      <ul class="nav nav-tabs align-items-center justify-content-between">
        <li class="nav-item" id="userRecipes">
          <a class="nav-link" href="#">
              <i class="fas fa-utensils fa-2x"></i>
          </a>
        </li>
        <li class="nav-item" id="userFavorites">
          <a class="nav-link" href="#">
              <!--              <i class="far fa-bookmark fa-2x"></i>-->
              <i class="fas fa-bookmark fa-2x"></i>
          </a>
        </li>
        <li class="nav-item" id="userFollowers">
          <a class="nav-link" href="#">
              <i class="fas fa-users fa-2x"></i>
          </a>
        </li>
        <li class="nav-item" id="userFollowing">
          <a class="nav-link" href="#">
              <i class="fas fa-user-plus fa-2x"></i>
          </a>
        </li>
<!--            PROFILE OWNER ONLY TABS-->
        <li class="nav-item" id="userPantry">
          <a class="nav-link" href="#">
            <i class="fas fa-lemon"></i><i class="fas fa-apple-alt fa-2x"></i><i class="fas fa-carrot"></i>
          </a>
        </li>
        <li class="nav-item" id="suggestions">
          <a class="nav-link" href="#">
            <i class="fas fa-drumstick-bite fa-2x"></i>
          </a>
        </li>
      </ul>
    </div>
<!--    RENDERED CONTENT-->
    <div id="userContent"></div>
</main>
<!--MODALS-->

<!-- Add Ingredient Modal -->
<div class="modal fade" id="ingredientModal" tabindex="-1" role="dialog" aria-labelledby="ingredientModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ingredientModalLabel">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="ingredientForm" >
          <div class="modal-body"  id="ingredientModalContent">
            <div class="form-group">
              <input name="name" type="hidden" class="form-control" id="ingredientName">
            </div>
            <div class="container d-flex justify-content-center">
              <div class="form-group">
                <label >Amount</label>
                <div class="qty mt-1">
                  <span class="minus"><i class="fas fa-minus-circle"></i></span>
                  <input type="number" class="count" name="qty" value="1.0" step=".05" placeholder="0.05" required>
                  <span class="plus"><i class="fas fa-plus-circle"></i></span>
                </div>
              </div>
              <div class="form-group">
                <label>Unit</label>
                <div class="mt-1">
                  <select name="unit" required>
                    <option th:value="teaspoon">Teaspoon (tsp)</option>
                    <option th:value="tablespoon">Tablespoon (Tbsp)</option>
                    <option th:value="ounce">Ounce (oz)</option>
                    <option th:value="cup">Cup (c)</option>
                    <option th:value="pint">Pint (pt)</option>
                    <option th:value="quart">Quart (qt)</option>
                    <option th:value="gallon">Gallon (gal)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button id="addIngredient" type="submit" class="btn btn-primary">Save</button>
          </div>
      </form>
    </div>
  </div>
</div>
<!--Todo: FIX SCRIPT CONFIGURATION-->

<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>

<script th:src="@{/js/ingredients.js}"></script>
<script th:inline="javascript">

  /* GET USER ID FROM THYMELEAF */
  (function($) {

    let userId = /*[[${user.id}]]*/ '';
    // API CALL TO CREATE HTML CONTENT
    let recipesHtml = "";
    let favoritesHtml = "";
    let followingHtml = "";

    // RECIPES
      $.ajax({'url': '/api/users/'+userId+"/recipes"}).done(function (recipes) {
        recipesHtml = renderRecipes(recipes,"owner");
      });

    // FAVORITES
    $.ajax({'url': '/api/users/'+userId+"/favorites"}).done(function (favorites) {
      favoritesHtml = renderRecipes(favorites,"favorites");
    });

    // RENDER RECIPE CARDS USED FOR PROFILE OWNER PERSONAL,FAVORITED AND SUGGESTED RECIPES
    const renderRecipes = (recipesToRender,recipesType) =>{
      let title;
      switch(recipesType){
        case "owner":
          title = recipesToRender[0].chef.firstName +"'s";
          break ;
        case "favorites":
          title = "Favorited";
          break;
        case "suggested":
          title = "Suggested";
          break;
        default:
          title = "";
      }
      let html = "";
      html += '<div class="container">';
      html +=   '<div class="row">';
      html +=     '<div class="col-md-12">'
      html +=       '<h3 class="my-3">'+ title +' Recipes</h3>';
      html +=     '</div>';

      recipesToRender.forEach((recipe)=>{
        html += '<div class="align-items-center justify-content-around">';
        html +=   '<div class="h-100 px-2 my-2 border-none bg-transparent recipe-card" style="width: 18rem;" >';
        html +=     '<a href="/recipes/'+recipe.id+'">'
        html +=     '<img class="card-img-top shadow" style="border-radius:1.5rem!important" src="' + recipe.images[0].url + '"/>';
        html +=     '</a>'
        html +=     '<div class="card-body bg-transparent">';
        html +=       '<h5 class="card-title font-weight-bold">' +  recipe.title + '</h5>';
        html +=       '<div class="row align-items-baseline">'
        html +=           '<div class="col-2">' +
                              '<a href="/users/'+recipe.chef.id+'">'+
                                '<img src="' + recipe.chef.avatar+'" class="rounded-circle" style="width: 40px;height: 40px">' +
                              '</a>' +
                          '</div>' +
                          '<div class="col-6"' +
                              '<p>'+ recipe.chef.firstName+ '</p>' +
                          '</div>';
        html +=           '<div class="col-3">' +
                              '<div class="rounded-pill border text-center" style="width: 75px">' +
                                  '<i class="far fa-heart"></i> ' + recipe.favoritedBy.length +
                              '</div>' +
                          '</div>';
        html +=       '</div>';
        html +=     '</div>';
        html +=   '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
      return html;
    }

    // FOLLOWING
    $.ajax({'url': '/api/users/'+userId+"/following"}).done(function (following) {
      followingHtml += '<div class="container"><div class="row align-items-center justify-content-around">';
      following.forEach(function(friend) {
          followingHtml += '<div class="my-2 text-center">'+
                            '<a href="/users/'+ friend.id + '">'+
                            '<img src="'+ friend.avatar +'" class="rounded-circle shadow-sm" style="border: 5px solid rgb(255, 255, 255);" alt="avatar">'+
                            '</a>'+
                            '<p>'+friend.firstName+'</p>'+
                          '</div>';
      });
      followingHtml += '</div></div>';
    });

    /* ON CLICK EVENTS FOR TAB UL */

    // RECIPES
    $( "#userRecipes" ).click(function() {
      $('#userContent').html(recipesHtml);
    });

    // FAVORITES
    $( "#userFavorites" ).click(function() {
      $('#userContent').html(favoritesHtml);
    });

    // FOLLOWERS
    $( "#userFollowers" ).click(function() {
      $.ajax({'url': '/api/users/'+userId+"/followers"}).done(function (followers) {
        let followersHtml = "";
        followersHtml = '<div class="container mt-3"><div class="row align-items-center justify-content-around">';
        followers.forEach(function(follower) {
          followersHtml += '<div class="my-2 text-center">'+
                  '<a class="text-center" href="/users/'+ follower.id + '">'+
                  '<img src="'+ follower.avatar +'" class="rounded-circle shadow-sm" style="border: 5px solid rgb(255, 255, 255);" alt="avatar">'+
                  '</a>'+
                  '<p>'+follower.firstName+'</p>'+
                  '</div>';
        });
        followersHtml += '</div></div>';
        $('#userContent').html(followersHtml);
      });
    });

    // FOLLOWING
    $( "#userFollowing" ).click(function() {
      $('#userContent').html(followingHtml);
    });

    // FOLLOW BTN SUBMIT A FOLLOW REQUEST
    $( "#addFriend" ).click(function() {
      let formData = {
        "friendId" : userId
      }
      let url = "/users/follow";
      $.ajax({
        type: "POST",
        contentType: "application/json",
        url: url,
        data: JSON.stringify(formData),
        // data: JSON.stringify(userId),
        dataType: 'json'
      }).done(function (response){
        $('#addFriend').text("Following");
        $('#addFriend').prop("disabled", true);
      });
    });

    /* PROFILE OWNER JS */

    // RECIPE SUGGESTIONS
    $( "#suggestions" ).click(function() {
      $.ajax({'url': '/api/users/'+userId+"/matches"}).done(function (recipes) {
        let suggestionsHtml = renderRecipes(recipes,"suggested");
        $('#userContent').html(suggestionsHtml);
      });
    });

    // PANTRY
    let pantryInventory;
    let inventoryIngredients;
    const makePantryAjaxCall = ()=>{
      pantryInventory = [];
      inventoryIngredients = [];
      $.ajax({'url': '/api/users/'+userId+"/pantry"}).done(function (response) {
        response.pantryIngredients.forEach(function(item) {
          inventoryIngredients.push(item);
          pantryInventory.push(item.ingredient.name.toLowerCase());
        });
      });
    }

    // CREATE HTML FOR PANTRY TEMPLATE
    const renderPantry = ()=>{
      // SORT INGREDIENTS BY NAME
      inventoryIngredients.sort((a, b) => (a.ingredient.name > b.ingredient.name) ? 1 : -1);
      let pantryHtml = "";
      pantryHtml +=
              '<div class="container">'+
              '<div class="row">'+
              '<div class="col-md-12">'+
              '<h2 class="pt-3 pb-4 text-center font-bold font-up deep-purple-text">Your Pantry</h2>'+
              '<div class="text-center"><input type="button" id="showIngredientForm" class="btn btn-sm" value="Add New Ingredient"/></div>'+
              '<div class="">' +
              '<input class="form-control my-2 py-1 pl-3 d-none" type="text" placeholder="Search by Name." type="text" id="ingredientSearch" />'+
              '<div id="searchResults" class="container text-center"></div>'+
              '</div>'+
              '</div>'+
              '</div>'
      ;
      // PANTRY INGREDIENT TABLE
      pantryHtml += '<div class="card shadow mt-3">';
      pantryHtml += '<table class="table table-striped">'+
              '<thead>'+
              '<tr>'+
              '<th>Ingredient</th>'+
              '<th>Amount</th>'+
              '<th></th>'+
              '</tr>'+
              '</thead>'+
              '<tbody>'
      ;
      // ADD ROWS TO PANTRY TABLE
      inventoryIngredients.forEach((item)=>{
        pantryHtml += '<tr>'+
                '<td><span>' + item.ingredient.name + '</span></td>'+
                '<td><span class="rational">' + item.amount + '</span><span> ' + item.unit+ '</span></td>'+
                '<td class="qty">'+
                '<span class="minus"><i class="fas fa-minus-circle"></i></span>&nbsp&nbsp' +
                '<span class="plus"><i class="fas fa-plus-circle"></i></span>'+
                '</td>'+
                '</tr>'
        ;
      })
      // CLOSE PANTRY HTML TEMPLATE
      pantryHtml += '</tbody>'+
              '</table>'+
              '</div>'+
              '</div>'
      ;
      // RENDER TEMPLATE
      $('#userContent').html(pantryHtml);
    }

    $( "#userPantry" ).click(function() {
      makePantryAjaxCall();
      setTimeout(function() {
        renderPantry();
        convertAllRationals();
      }, 500);
    });

    // AUTOSEARCH INGREDIENTS FOR PANTRY
    $(document).on('keyup',"#ingredientSearch",function(){
      let searchResults = $('#searchResults');
      let searchInput = this.value.trim();
      /* dont display any suggestions if empty string */
      if(this.value === "") {
        searchResults.empty();
      }else if(pantryInventory.includes(searchInput.toLowerCase())){
        console.log("found");
        searchResults.empty();
        searchResults.append(
                '<button id="ingredientInput" type="button" class="btn btn-primary" data-toggle="modal" data-target="#ingredientModal" disabled>'+searchInput.toLowerCase()+' is in pantry</button>'
        );
      }
      else{
        searchResults.empty();
        searchResults.append(
                '<button id="ingredientInput" type="button" class="btn btn-primary" data-toggle="modal" data-target="#ingredientModal">'+searchInput.toLowerCase()+'</button>'
        );

        /* search ingredients list to auto suggest ingredients and if not in list allow user to select own input */
        ingredientsList.filter(function(ingredient){
          if(ingredient.toLowerCase() === searchInput.toLowerCase()){
            $("#ingredientInput").addClass("d-none");
          }
          if (ingredient.toLowerCase().startsWith(searchInput.toLowerCase())) {
            searchResults.append(
                    '<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ingredientModal">'+ingredient+'</button>'
            );
          }
        });
        searchResults.append("</div>");
      }
    });

    // USER PANTRY ADD NEW PANTRY INPUT CLICK
    $(document).on('click',"#showIngredientForm", function () {
      let input = $("#ingredientSearch");
      if(input.hasClass("d-none")){
        $(this).prop('value', 'close');
        input.removeClass("d-none");
      }
      else{
        $(this).prop('value', 'Add New Ingredient');
        input.addClass("d-none");
      }
    })

    // INGREDIENT MODAL ON SHOW DYNAMIC INFO
    $('#ingredientModal').on('show.bs.modal', function (event) {
      let openModal = $(this);
      let button = $(event.relatedTarget); // Button that triggered the modal
      let clickedIngredient = button[0].innerHTML;
      // Plus Minus Count for form modal
      let count = $('#ingredientForm').find('input.count');
      $(document).on('click','.plus',function(){
        if (count.val() == 0) {
          count.val(0);
        }
        count.val(parseFloat(count.val()) + 1);
      });
      $(document).on('click','.minus',function(){
        count.val(parseFloat(count.val()) - 1);
        if (count.val() == 0) {
          count.val(1);
        }
      });
      openModal.find('.modal-title').text("Add "+clickedIngredient+" to pantry");
      openModal.find('.modal-body input').val(clickedIngredient);
    })

    // ON INGREDIENT MODAL SUBMIT POST REQUEST ADD INGREDIENT TO PANTRY
    $("#ingredientForm").submit(function () {
      $('#ingredientModal').modal('toggle');
      let form = $(this);
      let url = "/users/pantry/ingredient/new";
      let formData = JSON.stringify({
        "name" : form.find('input#ingredientName').val(),
        "amount": form.find('input.count').val(),
        "unit" : form.find('select  option:selected').text()
      });
      $.ajax({
          type: "POST",
          contentType: "application/json",
          url: url,
          data: formData,
          dataType: "json",
      });

      setTimeout(function() {
        makePantryAjaxCall();
      }, 1000);
      setTimeout(function() {
        renderPantry();
        convertAllRationals();
      }, 1500);

      return false;
    })
  })(jQuery);



  // $("#createUser").submit(function(e) {
  //
  //     e.preventDefault(); // avoid to execute the actual submit of the form.
  //
  //     var form = $(this);
  //     var url = form.attr('action');
  //     var formData = JSON.stringify($(this).serializeArray());
  //     console.log(formData);
  //     $.ajax({
  //         type: "POST",
  //         url: url,
  //         data: formData,
  //         dataType: "json",
  //         contentType : "application/json"
  //     });
  //
  //
  // });
  /*]]>*/
</script>
<script th:src="@{/js/fraction_converter.js}"></script>
</body>
</html>
